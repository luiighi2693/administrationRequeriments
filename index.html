<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Post v2 Roadmap</title>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
  <link rel="stylesheet" href="bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css">
  <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
  <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">

  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<body class="skin-blue sidebar-mini sidebar-collapse" style="height: auto; min-height: 100%;">

<div class="wrapper">
  <header class="main-header">
    <nav class="navbar navbar-static-top" style="margin-left: 0;">
      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          <li class="dropdown user user-menu">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <!--<img src="dist/img/user.png" class="user-image" alt="User Image">-->
              <span class="hidden-xs" id="role"></span>
              <span class="hidden-xs" id="username1"></span>
            </a>
            <ul class="dropdown-menu">
              <li class="user-header">
                <!--<img src="dist/img/user.png" class="img-circle" alt="User Image">-->
                <p id="username2"></p>
              </li>
              <li class="user-footer">
                <div class="pull-right">
                  <a href="#" class="btn btn-default btn-flat" onclick="logout()">Log out</a>
                </div>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <div class="content-wrapper" style="margin-left: 0 !important;">
    <section id="newSection" class="content" style="display: none;">
      <div class="row">
        <div class="col-xs-12">
          <div class="box box-primary">
            <div class="box-header with-border">
              <h3 class="box-title" id="tittleNewEditRequeriment">New Requirement</h3>
            </div>
            <!-- /.box-header -->
            <!-- form start -->
            <div role="form">
              <div class="box-body">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="priorityInput">Priority</label>
                    <input type="text" class="form-control" id="priorityInput" placeholder="Enter priority">
                  </div>
                 <!--<div class="row">-->
                   <!--<div class="form-group col-md-10">-->
                   <div class="form-group">
                     <label for="teamInput">Team</label>
                     <input type="text" class="form-control" id="teamInput" placeholder="Enter Team">
                   </div>
                   <!--<div class="checkbox col-md-2">-->
                     <!--<label>-->
                       <!--<input id="swapped" type="checkbox"> Swapped-->
                     <!--</label>-->
                   <!--</div>-->
                 <!--</div>-->
                  <div class="form-group">
                    <label>Sprint</label>
                      <input type="text" class="form-control" id="deadLineInput" placeholder="Enter a Sprint">
                    <!--<div class="input-group date">-->
                      <!--<div class="input-group-addon">-->
                        <!--<i class="fa fa-calendar"></i>-->
                      <!--</div>-->
                      <!--<input type="text" class="form-control" id="deadLineInput">-->
                    <!--</div>-->
                    <!-- /.input group -->
                  </div>

                    <div class="form-group">
                        <label>Points</label>
                        <input type="text" class="form-control" id="pointInput" placeholder="Enter a Point"  min="0">
                    </div>

                  <div class="form-group">
                    <label>Link</label>
                    <div class="input-group">
                      <input id="linkText" type="text" class="form-control" placeholder="Enter a Link" disabled="">
                      <span class="input-group-btn">
                      <button type="button" class="btn btn-info btn-flat" data-toggle="modal" data-target="#modal-default">New</button>
                    </span>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="statusInput">Status</label>
                    <input type="text" class="form-control" id="statusInput" placeholder="Enter Status">
                  </div>
                  <div class="form-group" style="display: flex">
                    <div class="radio" style="margin-top: 0 !important; margin-right: 2%;">
                      <label>
                        <input type="radio" name="colorRadios" id="colorRadiosWhite" value="#ffffff" checked>
                        <span class="label" style="background-color: #ffffff; color: #0a0a0a;">white</span>
                      </label>
                    </div>
                    <div class="radio" style="margin-top: 0 !important; margin-right: 2%;">
                      <label>
                        <input type="radio" name="colorRadios" id="colorRadiosBlue" value="#a1cfea" >
                        <span class="label" style="background-color: #a1cfea; color: #0a0a0a;">blue</span>
                      </label>
                    </div>
                    <div class="radio" style="margin-top: 0 !important; margin-right: 2%;">
                      <label>
                        <input type="radio" name="colorRadios" id="colorRadiosYellow" value="#e2dd3b">
                        <span class="label" style="background-color: #e2dd3b; color: #0a0a0a;">yellow</span>
                      </label>
                    </div>
                    <div class="radio" style="margin-top: 0 !important; margin-right: 2%;">
                      <label>
                        <input type="radio" name="colorRadios" id="colorRadiosOrange" value="#f17913">
                        <span class="label" style="background-color: #f17913; color: #0a0a0a;">orange</span>
                      </label>
                    </div>
                    <div class="radio" style="margin-top: 0 !important; margin-right: 2%;">
                      <label>
                        <input type="radio" name="colorRadios" id="colorRadiosRed" value="#f11313">
                        <span class="label" style="background-color: #f11313; color: #0a0a0a;">red</span>
                      </label>
                    </div>
                    <div class="radio" style="margin-top: 0 !important; margin-right: 2%;">
                      <label>
                        <input type="radio" name="colorRadios" id="colorRadiosGreen" value="#63dea6">
                        <span class="label" style="background-color: #63dea6; color: #0a0a0a;">green</span>
                      </label>
                    </div>
                    <!--<label for="statusInput">Status</label>-->
                    <!--<select class="form-control select2 select2-hidden-accessible" style="width: 100%;" tabindex="-1" aria-hidden="true" id="statusInput">-->
                      <!--<option selected="selected"></option>-->
                      <!--<option>In queue</option>-->
                      <!--<option>Processing</option>-->
                      <!--<option>Completed</option>-->
                      <!--<option>Blocked</option>-->
                      <!--<option>Awating</option>-->
                      <!--<option>Information</option>-->
                    <!--</select>-->
                  </div>

                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="idInput">Id</label>
                    <input type="text" class="form-control" id="idInput" placeholder="Enter id">
                  </div>
                  <div class="form-group">
                    <label for="RequerimentInput">Feature / Requirement</label>
                    <input type="text" class="form-control" id="requerimentInput" placeholder="Enter Feature / Requirement">
                  </div>
                  <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" rows="5" id="descriptionInput" placeholder="Enter ..."></textarea>
                  </div>
                  <div class="form-group">
                    <label>Impact</label>
                    <textarea class="form-control" rows="5" id="impactInput" placeholder="Enter ..."></textarea>
                  </div>
                  <!--<div class="form-group">-->
                    <!--<label for="teamInput">Notify To Email</label>-->
                    <!--<input type="email" class="form-control" id="emailToNotify" placeholder="Enter a Email">-->
                  <!--</div>-->
                </div>
              </div>

              <div class="box-footer">
                <button class="btn btn-primary" onclick="onSave()">Save</button>
                <button class="btn btn-default" onclick="cancelNewRequeriment()">cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content-header">
      <h1>
        Post v2 Roadmap
        <button id="newSectionButton" type="button" class="btn btn-block btn-primary pull-right" style="width: 10%;" onclick="showNewSection()">Add Requirement</button>
      </h1>
      <div class="col-md-12">
        <div class="chart-legend clearfix">
          <i class="fa fa-square" style="color: #a1cfea;"></i> Completed &nbsp;&nbsp;&nbsp;
          <i class="fa fa-square" style="color: #63dea6;"></i> In-Progress &nbsp;&nbsp;&nbsp;
          <i class="fa fa-square" style="color: #e2dd3b;"></i> Next Sprint &nbsp;&nbsp;&nbsp;
          <i class="fa fa-square" style="color: #f17913;"></i> Action Required &nbsp;&nbsp;&nbsp;
          <i class="fa fa-square" style="color: #f11313;"></i> Blocking Issue &nbsp;&nbsp;&nbsp;
          <i class="fa fa-square" style="color: #ffffff;"></i> In Queue
        </div>
        <br>
      </div>
    </section>

    <section class="content">
      <div class="row">
        <div class="col-xs-12">
          <div class="box">
            <div class="box-body">
              <table id="example1" class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>#</th>
                    <th id="actionRowApprovedRequeriments">Actions</th>
                    <th>Prio</th>
                    <th>Id</th>
                    <th>Team</th>
                    <th>Feature / Requirement</th>
                    <th>Description</th>
                    <th>Impact</th>
                    <th>Link</th>
                    <th>Status</th>
                    <th>Sprint</th>
                    <th>Points</th>
                    <th>Notes</th>
                </tr>
                </thead>
                  <tbody id="tableBody">
                  </tbody>
              </table>
            </div>
            <div class="overlay" style="display: none;">
              <i class="fa fa-refresh fa-spin"></i>
            </div>
          </div>
        </div>
      </div>
    </section>


    <section class="content-header">
      <h1>
        Pending Approval
      </h1>
    </section>

    <section class="content">
      <div class="row">
        <div class="col-xs-12">
          <div class="box">
            <div class="box-body">
              <table id="example2" class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>#</th>
                    <th id="actionRowNotApprovedRequeriments">Actions</th>
                    <th>Prio</th>
                    <th>Id</th>
                    <th>Team</th>
                    <th>Feature / Requirement</th>
                    <th>Description</th>
                    <th>Impact</th>
                    <th>Link</th>
                    <th>Status</th>
                    <th>Sprint</th>
                    <th>Points</th>
                </tr>
                </thead>
                <tbody id="tableBody2">
                </tbody>
              </table>
            </div>
            <div class="overlay" style="display: none;">
              <i class="fa fa-refresh fa-spin"></i>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!--<section class="content-header">-->
      <!--<h1>-->
        <!--Swapped-->
      <!--</h1>-->
    <!--</section>-->

    <!--<section class="content">-->
      <!--<div class="row">-->
        <!--<div class="col-xs-12">-->
          <!--<div class="box">-->
            <!--<div class="box-body">-->
              <!--<table id="example3" class="table table-bordered table-striped">-->
                <!--<thead>-->
                <!--<tr>-->
                  <!--<th>#</th>-->
                  <!--<th id="actionRowRequerimentsSwapped">Actions</th>-->
                  <!--<th>Priority</th>-->
                  <!--<th>Id</th>-->
                  <!--<th>Team</th>-->
                  <!--<th>Deadline</th>-->
                  <!--<th>Feature / Requirement</th>-->
                  <!--<th>Description</th>-->
                  <!--<th>Impact</th>-->
                  <!--<th>Link</th>-->
                  <!--<th>Status</th>-->
                <!--</tr>-->
                <!--</thead>-->
                <!--<tbody id="tableBody3">-->
                <!--</tbody>-->
              <!--</table>-->
            <!--</div>-->
            <!--<div class="overlay" style="display: none;">-->
              <!--<i class="fa fa-refresh fa-spin"></i>-->
            <!--</div>-->
          <!--</div>-->
        <!--</div>-->
      <!--</div>-->
    <!--</section>-->
  </div>
  <div class="control-sidebar-bg"></div>
</div>

<div class="modal fade" id="modal-default">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Link</h4>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Title</label>
          <input id="titleLink" type="text" class="form-control" placeholder="Enter a Title Link">
        </div>
        <div class="form-group">
          <label>Url</label>
          <input id="urlLink" type="text" class="form-control" placeholder="Enter a Url">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveUrl()" data-dismiss="modal">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-delete">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Delete</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure that you want delete this item?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left" onclick="cancelDelete()" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="deleteRequeriment()" data-dismiss="modal">Delete</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-comments">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Comments</h4>
      </div>
      <div class="modal-body">
        <div class="direct-chat-messages" id="commentBody">
          
        </div>

        <div id="addCommentButton" style="display: block;">
          <div class="col-xs-2">
            <button type="button" class="btn btn-block btn-primary" onclick="addComment()"><i class="fa fa-plus"></i></button>
          </div>
          <div class="col-xs-10">
          </div>
        </div>

        <div id="addCommentForm" style="display: none;">
          <div>
            <div class="box-body">
              <h4 id="commentFormTitle">New Comment</h4>

              <div class="form-group">
                <input type="text" class="form-control" id="emailNotyfyComment" placeholder="Name">
              </div>
              <div class="row">
                <div class="col-xs-1">
                  <div class="radio" style="margin-top: 0;">
                    <label>
                      <input type="radio" name="flagRadios" id="flagRadios1" value="green" checked>
                      <i class="fa fa-fw fa-flag-o bg-green"></i>
                    </label>
                  </div>
                  <div class="radio">
                    <label>
                      <input type="radio" name="flagRadios" id="flagRadios2" value="yellow">
                      <i class="fa fa-fw fa-flag-o bg-yellow"></i>
                    </label>
                  </div>
                  <div class="radio">
                    <label>
                      <input type="radio" name="flagRadios" id="flagRadios3" value="red">
                      <i class="fa fa-fw fa-flag-o bg-red"></i>
                    </label>
                  </div>
                </div>
                <div class="col-xs-11">
                  <textarea class="form-control" rows="3" placeholder="Enter a comment" maxlength="5000" id="textAreaComment"></textarea>
                </div>
              </div>

            </div>
            <!-- /.box-body -->
            <div class="box-footer">
              <button id="cancelCommentButton" class="btn btn-default" onclick="cancelComment()">Cancel</button>
              <button class="btn btn-info pull-right" onclick="saveComment()">save</button>
            </div>
            <!-- /.box-footer -->
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <!--<button type="button" class="btn btn-default pull-left" onclick="cancelDelete()" data-dismiss="modal">Cancel</button>-->
        <!--<button type="button" class="btn btn-danger" onclick="deleteRequeriment()" data-dismiss="modal">Delete</button>-->
      </div>
    </div>
  </div>
</div>

<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script src="bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<script src="bower_components/fastclick/lib/fastclick.js"></script>
<script src="bower_components/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
<script src="dist/js/adminlte.min.js"></script>
<script src="dist/js/demo.js"></script>
<script>
    let idToDelete = '';
    let idToEdit = '';
    let data = [];
    let data2 = [];
    let data3 = [];
    let dataToEdit = {};
    let dataUser = {};
    let firsTimeFlag = true;

    let idRequerimentSelected = '';
    let editComment = false;
    let isAnswer = false;
    let editAnswer = false;
    let isSwapped = false;
    let hasComment = true;

    let comment = {};
    let idComment = '';

    function printBackgroundColor(statusColor) {
        // if (status === 'Processing')
        //   return 'style="background-color: #f39c12;"';
        //
        // if (status === 'Blocked')
        //   return 'style="background-color: #dd4b39;"';
        //
        // if (status === 'Completed')
        //   return 'style="background-color: #63dea6;"';
        return 'style="background-color: '+statusColor+';"';
    }

    function saveUrl() {
        $('#linkText').val($('#titleLink').val());
    }

    function cleanFields() {
        $('#titleLink').val('Confluence Page');
        $('#urlLink').val('');
        $('#linkText').val('');
        $('#priorityInput').val('');
        $('#teamInput').val('');
        $('#idInput').val('');
        $('#deadLineInput').val('');
        $('#pointInput').val('');
        $('#requerimentInput').val('');
        $('#statusInput').val('');
        $('input[name=colorRadios][value="#ffffff"]').prop('checked', true);
        $('#descriptionInput').val('');
        $('#impactInput').val('');
        // $('#swapped').prop("checked", false)
    }

    function showNewSection() {
        $('#newSection').css('display','block' );
        $('#newSectionButton').css('display','none' );
        $('#tittleNewEditRequeriment').text('New Requirement');

        cleanFields();
    }

    function cancelNewRequeriment() {
        $('#newSection').css('display','none' );
        $('#newSectionButton').css('display','block' );

        cleanFields();
    }

    function getCustomLink(title, url) {
        return title.length === 0 ? '' : '<a target="_blank" href="'+url+'">'+title+'</a>';
    }

    function onSave() {
        if (idToEdit !== '') {
            editRequeriment();
        }else{
            createRequeriment();
        }
    }

    function createRequeriment() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "createRequeriment",
                "priority": $('#priorityInput').val().split('.')[0],
                "idRow": $('#idInput').val(),
                "team": $('#teamInput').val(),
                "deadLine": $('#deadLineInput').val(),
                "pointRequeriment": $('#pointInput').val(),
                "feature": $('#requerimentInput').val(),
                "description": $('#descriptionInput').val().replace("'", "&#39;"),
                "impact": $('#impactInput').val(),
                "link": getCustomLink($('#titleLink').val(), $('#urlLink').val()),
                "statusRequeriment": $('#statusInput').val(),
                "colorStatus": $('input[name=colorRadios]:checked').val(),
                // "swapped": $('#swapped').is(":checked").toString(),
                "swapped": "false",
                "approved": 'false',
                "orderRequeriment": $('#priorityInput').val().split('.')[1]
            },
            success: function(response){
                console.log(response);
                cancelNewRequeriment();
                getRequeriments();
            }
        });
    }

    function editRequeriment() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "editRequeriment",
                "id" : idToEdit,
                "priority": $('#priorityInput').val().split('.')[0],
                "idRow": $('#idInput').val(),
                "team": $('#teamInput').val(),
                "deadLine": $('#deadLineInput').val(),
                "pointRequeriment": $('#pointInput').val(),
                "feature": $('#requerimentInput').val(),
                "description": $('#descriptionInput').val().replace("'", "&#39;"),
                "impact": $('#impactInput').val(),
                "link": getCustomLink($('#titleLink').val(), $('#urlLink').val()),
                "statusRequeriment": $('#statusInput').val(),
                "colorStatus": $('input[name=colorRadios]:checked').val(),
                // "swapped": $('#swapped').is(":checked").toString(),
                "swapped": "false",
                "approved": dataToEdit.approved,
                "orderRequeriment": $('#priorityInput').val().split('.')[1]
            },
            success: function(response){
                console.log(response);
                idToEdit = '';
                dataToEdit = {};
                cancelNewRequeriment();
                getRequeriments();
            }
        });
    }

    function editRequerimentCustom() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "editRequeriment",
                "id" : idToEdit,
                "priority": dataToEdit.priority,
                "idRow": dataToEdit.idRow,
                "team": dataToEdit.team,
                "deadLine": dataToEdit.deadLine,
                "pointRequeriment": dataToEdit.pointRequeriment,
                "feature": dataToEdit.feature,
                "description": dataToEdit.description.replace("'", "&#39;"),
                "impact": dataToEdit.impact,
                "link": dataToEdit.link,
                "statusRequeriment": dataToEdit.statusRequeriment,
                "colorStatus": dataToEdit.colorStatus,
                // "swapped": dataToEdit.swapped,
                "swapped": "false",
                "approved": dataToEdit.approved,
                "orderRequeriment": data.filter(d => d.priority === dataToEdit.priority).length + 1
            },
            success: function(response){
                console.log(response);
                idToEdit = '';
                dataToEdit = {};
                cancelNewRequeriment();
                getRequeriments();
            }
        });
    }

    function editRequerimentCustom2() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "editRequeriment",
                "id" : idToEdit,
                "priority": dataToEdit.priority,
                "idRow": dataToEdit.idRow,
                "team": dataToEdit.team,
                "deadLine": dataToEdit.deadLine,
                "pointRequeriment": dataToEdit.pointRequeriment,
                "feature": dataToEdit.feature,
                "description": dataToEdit.description.replace("'", "&#39;"),
                "impact": dataToEdit.impact,
                "link": dataToEdit.link,
                "statusRequeriment": dataToEdit.statusRequeriment,
                "colorStatus": dataToEdit.colorStatus,
                // "swapped": dataToEdit.swapped,
                "swapped": "false",
                "approved": dataToEdit.approved,
                "orderRequeriment": dataToEdit.orderRequeriment
            },
            success: function(response){
                console.log(response);
            },
            async: false
        });
    }

    function orderByPriority(priority){
      let d1 = data.filter(d => d.priority === priority);
      let i = 1;
      d1.forEach(d => {
        d.orderRequeriment = i;
        idToEdit = d.id;
        dataToEdit = d;
        editRequerimentCustom2();
        i++;
      });
    } 

    function orderByPriority2(data, priority){
      let d1 = data.filter(d => d.priority === priority);
      let i = 1;
      d1.forEach(d => {
        d.orderRequeriment = i;
        idToEdit = d.id;
        dataToEdit = d;
        editRequerimentCustom2();
        i++;
      });
    } 

    function getRequerimentsToOrder(priority) {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "getRequeriments",
            },
            success: function(response){
                console.log($.parseJSON(response));
                data = $.parseJSON(response).filter(d => d.approved === 'true');
            orderByPriority2(data, priority);
            },
            async: false
        });
    }

    function approveAll(){
      let d1 = data2;
      let i = 0;
      d1.forEach(d => {
        d.order = i;
        d.approved = 'true';
        idToEdit = d.id;
        dataToEdit = d;
        editRequerimentCustom2();
        i++;
      });
    }

    function editRequerimentCustomWithoutRefreshData(requeriments) {
        requeriments.forEach(d => {
            $.ajax({
                type: "POST",
                url: "backend/util.php",
                data: {
                    "method" : "editRequeriment",
                    "id" : d.id,
                    "priority": d.priority,
                    "idRow": d.idRow,
                    "team": d.team,
                    "deadLine": d.deadLine,
                    "feature": d.feature,
                    "description": d.description,
                    "link": d.link,
                    "statusRequeriment": d.statusRequeriment,
                    // "swapped": d.swapped,
                    "swapped": "false",
                    "approved": d.approved,
                    "orderRequeriment": d.orderRequeriment
                },
                success: function(response){
                    console.log(response);
                }
            });
        });
    }

    function onEdit(id) {

        idToEdit = id;

        let d1 = data.filter(d => d.id === id.toString())[0];
        console.log(d1);
        showNewSection();
        $('#titleLink').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].text);
        $('#urlLink').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].href);
        $('#linkText').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].text);
        $('#priorityInput').val(d1.priority + '.' + d1.orderRequeriment);
        $('#teamInput').val(d1.team);
        $('#idInput').val(d1.idRow);
        $('#deadLineInput').val(d1.deadLine);
        $('#pointInput').val(d1.pointRequeriment);
        $('#requerimentInput').val(d1.feature);
        $('#statusInput').val(d1.statusRequeriment);
        $('input[name=colorRadios][value="'+d1.colorStatus+'"]').prop('checked', true);
        // $('#swapped').prop("checked", d1.swapped === 'true');

        $('#descriptionInput').val(d1.description
            .replace("<br/>", "<br/>\n")
            .replace("&#39;","'")
        );
        $('#impactInput').val(d1.impact.replace("<br/>", "<br/>\n"));
        dataToEdit = d1;

        $('#tittleNewEditRequeriment').text('Edit Requeriment');
    }

    function onEditSwapped(id) {

        idToEdit = id;

        let d1 = data3.filter(d => d.id === id.toString())[0];
        console.log(d1);
        showNewSection();
        $('#titleLink').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].text);
        $('#urlLink').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].href);
        $('#linkText').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].text);
        $('#priorityInput').val(d1.priority + '.' + d1.orderRequeriment);
        $('#teamInput').val(d1.team);
        $('#idInput').val(d1.idRow);
        $('#deadLineInput').val(d1.deadLine);
        $('#pointInput').val(d1.pointRequeriment);
        $('#requerimentInput').val(d1.feature);
        $('#statusInput').val(d1.statusRequeriment);
        $('input[name=colorRadios][value="'+d1.colorStatus+'"]').prop('checked', true);
        // $('#swapped').prop("checked", d1.swapped === 'true');

        $('#descriptionInput').val(d1.description.replace("<br/>", "<br/>\n"));
        $('#impactInput').val(d1.impact.replace("<br/>", "<br/>\n"));
        dataToEdit = d1;

        $('#tittleNewEditRequeriment').text('Edit Requeriment');
    }

    function deleteRequeriment() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "deleteRequeriment",
                "id" :idToDelete,
            },
            success: function(response){
                console.log(response);

                // let d1 = null;
                // let dataToOrder = null;
                // if (!isSwapped) {
                //     d1 = data.filter(d => d.id === idToDelete.toString());
                //     dataToOrder = data.filter(d => (d.priority === d1[0].priority.toString()) && (d.id !== d1[0].id));
                // } else {
                //     d1 = data3.filter(d => d.id === idToDelete.toString());
                //     dataToOrder = data3.filter(d => (d.priority === d1[0].priority.toString()) && (d.id !== d1[0].id));
                // }
                //
                // dataToOrder.forEach(dToOrder => {
                //     if (dToOrder.orderRequeriment > d1[0].orderRequeriment){
                //         dToOrder.orderRequeriment = dToOrder.orderRequeriment - 1;
                //     }
                // });
                //
                // editRequerimentCustomWithoutRefreshData(dataToOrder);

                getRequeriments();
            }
        });
    }

    function setIdToDelete(id) {
        isSwapped = false;
        idToDelete = id;
    }

    function setIdToDeleteSwapped(id) {
        isSwapped = true;
        idToDelete = id;
    }

    function cancelDelete() {
        idToDelete = '';
    }

    // function upRequeriment(id) {
    //     let d1 = data.filter(d => d.id === id.toString())[0];
    //     let d2 = data.filter(d => d.priority === d1.priority);
    //     if(d2.indexOf(d1)-1 >= 0)  {
    //         //change order in database
    //         let d3 = d2[d2.indexOf(d1)-1];
    //           //params to send
    //         console.log(d1.id, d3.orderRequeriment);
    //         console.log(d3.id, d1.orderRequeriment);
    //
    //         //refresh Data
    //         let tmp = d1.orderRequeriment;
    //         data.find(d => d.id === d1.id.toString()).orderRequeriment = d3.orderRequeriment;
    //         data.find(d => d.id === d3.id.toString()).orderRequeriment = tmp;
    //
    //         console.log(data);
    //
    //         fillData(data);
    //
    //         editRequerimentCustomWithoutRefreshData( [data.find(d => d.id === d1.id.toString()), data.find(d => d.id === d3.id.toString())] )
    //     }
    //     console.log(id);
    // }

    // function downRequeriment(id) {
    //     let d1 = data.filter(d => d.id === id.toString())[0];
    //     let d2 = data.filter(d => d.priority === d1.priority);
    //     if(d2.indexOf(d1)+1 < d2.length)  {
    //         //change order in database
    //         let d3 = d2[d2.indexOf(d1)+1];
    //         //params to send
    //         console.log(d1.id, d3.orderRequeriment);
    //         console.log(d3.id, d1.orderRequeriment);
    //
    //         //refresh Data
    //         let tmp = d1.orderRequeriment;
    //         data.find(d => d.id === d1.id.toString()).orderRequeriment = d3.orderRequeriment;
    //         data.find(d => d.id === d3.id.toString()).orderRequeriment = tmp;
    //
    //         console.log(data);
    //
    //         fillData(data);
    //         editRequerimentCustomWithoutRefreshData( [data.find(d => d.id === d1.id.toString()), data.find(d => d.id === d3.id.toString())] )
    //     }
    //     console.log(id);
    // }

    function approveRequeriment(id) {
        let d1 = data2.filter(d => d.id === id.toString())[0];
        d1.approved = 'true';
        console.log(d1);
        idToEdit = id;
        dataToEdit = d1;

        editRequerimentCustom();
    }

    function printActions(id) {
        return '' +
            // '<a href="#" onclick="upRequeriment('+id+')"><i class="fa fa-arrow-up"></i></span></a> ' +
            // '<a href="#" onclick="downRequeriment('+id+')"><i class="fa fa-arrow-down"></i></span></a> ' +
            '<a href="#" onclick="onEdit('+id+')">Edit</a> ' +
            '<a href="#" data-toggle="modal" data-target="#modal-delete" onclick="setIdToDelete('+id+')"><i class="fa fa-trash"></i></span></a>' +
            '';
    }

    function printActionsSwapped(id) {
        return '' +
            '<a href="#" onclick="onEditSwapped('+id+')">Edit</a> ' +
            '<a href="#" data-toggle="modal" data-target="#modal-delete" onclick="setIdToDeleteSwapped('+id+')"><i class="fa fa-trash"></i></span></a>' +
            '';
    }

    function printActionEdit(id) {
        return '' +
            '<a href="#" onclick="onEdit('+id+')">Edit</a> ' +
            '';
    }

    function printActionEditSwapped(id) {
        return '' +
            '<a href="#" onclick="onEditSwapped('+id+')">Edit</a> ' +
            '';
    }

    function printActionApproved(id) {
        return '' +
            '<a href="#" onclick="approveRequeriment('+id+')"><i class="fa fa-check"></i></span></a> ' +
            '';
    }

    function printDisplay(comments) {
        return comments.length === 0 ? "none" : "block";
    }

    function printComments(id, comments) {
        return '' +
            '<a href="#" data-toggle="modal" data-target="#modal-comments" onclick="changeRequerimentSelected('+id+')">' +
            '   <span class="badge bg-'+printColorCommentBag(comments)+'" style="display: '+printDisplay(comments)+'">'+comments.length+'</span>\n' +
            '   <i class="fa fa-edit"></i>' +
            '</a> ' +
            // '<a class="btn btn-app btn-app-custom" data-toggle="modal" data-target="#modal-comments" onclick="changeRequerimentSelected('+id+')">\n' +
            // '   <span class="badge bg-'+printColorCommentBag(comments)+'" style="display: '+printDisplay(comments)+'">'+comments.length+'</span>\n' +
            // '   <i class="fa fa-eye"></i>\n' +
            // ' </a>' +
            '';
    }

    function printColorCommentBag(comments) {
        if (comments.length === 0) {
            return 'green';
        } else {
            return comments[comments.length-1].flagAnswer === '' ? comments[comments.length-1].flagComment : comments[comments.length-1].flagAnswer;
        }
    }

    function printPoint(point) {
        return point === null ? '' : point;
    }

    function fillData(data) {

      let dataTmp = [];

      Array.from(data, x => x.priority).reduce((x, y) => x.includes(y) ? x : [...x, y], []).forEach(pr => {
          let dAux = data.filter(d => d.priority === pr);
          dAux.sort(function(a, b){return a.orderRequeriment-b.orderRequeriment});
          dAux.forEach(a => {
            dataTmp.push(a);
          });
      });

      data = dataTmp;

        $('#tableBody').empty();

        let i = 1;

        if (dataUser.role === 'ADMIN') {
            data.forEach(data => {
                $('#tableBody').append('' +
                    '<tr '+printBackgroundColor(data.colorStatus)+'>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+printActions(data.id)+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.impact+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+printPoint(data.pointRequeriment)+'</td>\n' +
                    '<td style="text-align: center;">'+printComments(data.id, data.comments)+'</td>\n' +
                    '</tr>');

                i++;
            });
        } else {
            data.forEach(data => {
                $('#tableBody').append('' +
                    '<tr '+printBackgroundColor(data.colorStatus)+'>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+printActionEdit(data.id)+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.impact+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+printPoint(data.pointRequeriment)+'</td>\n' +
                    '<td style="text-align: center;">'+printComments(data.id, data.comments)+'</td>\n' +
                    '</tr>');

                i++;
            });
        }

         dataTmp = [];

      Array.from(data2, x => x.priority).reduce((x, y) => x.includes(y) ? x : [...x, y], []).forEach(priority => {
          dAux = data2.filter(d => d.priority === priority);
          dAux.sort(function(a, b){return a.orderRequeriment-b.orderRequeriment});
          dAux.forEach(a => {
            dataTmp.push(a);
          });
      });

      data2 = dataTmp;

        $('#tableBody2').empty();
        i = 1;

        if (dataUser.role === 'ADMIN') {
            data2.forEach(data => {
                $('#tableBody2').append('' +
                    '<tr '+printBackgroundColor(data.colorStatus)+'>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+printActionApproved(data.id)+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.impact+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+printPoint(data.pointRequeriment)+'</td>\n' +
                    '</tr>');

                i++;
            });
        } else {
            data2.forEach(data => {
                $('#tableBody2').append('' +
                    '<tr '+printBackgroundColor(data.colorStatus)+'>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.impact+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+printPoint(data.pointRequeriment)+'</td>\n' +
                    '</tr>');

                i++;
            });
        }



        // dataTmp = [];
        //
        // Array.from(data3, x => x.priority).reduce((x, y) => x.includes(y) ? x : [...x, y], []).forEach(priority => {
        //     dAux = data3.filter(d => d.priority === priority);
        //     dAux.sort(function(a, b){return a.orderRequeriment-b.orderRequeriment});
        //     dAux.forEach(a => {
        //         dataTmp.push(a);
        //     });
        // });
        //
        // data3 = dataTmp;
        //
        // $('#tableBody3').empty();
        // i = 1;
        //
        // if (dataUser.role === 'ADMIN') {
        //     data3.forEach(data => {
        //         $('#tableBody3').append('' +
        //             '<tr '+printBackgroundColor(data.colorStatus)+'>\n' +
        //             '<td style="text-align: center;">'+i+'</td>\n' +
        //             '<td style="text-align: center;">'+printActionsSwapped(data.id)+'</td>\n' +
        //             '<td style="text-align: center;">'+data.priority+'</td>\n' +
        //             '<td>'+data.idRow+'</td>\n' +
        //             '<td>'+data.team+'</td>\n' +
        //             '<td>'+data.deadLine+'</td>\n' +
        //             '<td>'+data.feature+'</td>\n' +
        //             '<td>'+data.description+'</td>\n' +
        //             '<td>'+data.impact+'</td>\n' +
        //             '<td>'+data.link+'</td>\n' +
        //             '<td>'+data.statusRequeriment+'</td>\n' +
        //             '</tr>');
        //
        //         i++;
        //     });
        // } else {
        //     data3.forEach(data => {
        //         $('#tableBody3').append('' +
        //             '<tr '+printBackgroundColor(data.colorStatus)+'>\n' +
        //             '<td style="text-align: center;">'+i+'</td>\n' +
        //             '<td style="text-align: center;">'+printActionEditSwapped(data.id)+'</td>\n' +
        //             '<td style="text-align: center;">'+data.priority+'</td>\n' +
        //             '<td>'+data.idRow+'</td>\n' +
        //             '<td>'+data.team+'</td>\n' +
        //             '<td>'+data.deadLine+'</td>\n' +
        //             '<td>'+data.feature+'</td>\n' +
        //             '<td>'+data.description+'</td>\n' +
        //             '<td>'+data.impact+'</td>\n' +
        //             '<td>'+data.link+'</td>\n' +
        //             '<td>'+data.statusRequeriment+'</td>\n' +
        //             '</tr>');
        //
        //         i++;
        //     });
        // }
    }

    function getRequeriments() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "getRequeriments",
            },
            success: function(response){
              if ($.parseJSON(response).length > 0){
                //console.log($.parseJSON(response));
                data = $.parseJSON(response).filter(d => d.approved === 'true');
                data2 = $.parseJSON(response).filter(d => d.approved !== 'true');
                // data3 = $.parseJSON(response).filter(d => d.approved === 'true' && d.swapped === 'true');

                getComments();
                
              } else {
                $('#tableBody').empty();
              }
            }
        });
    }

    function logout() {
        window.sessionStorage.setItem('token', null);
        window.location = dataUser.role === 'ADMIN' ? 'loginAdmin.html' : 'login.html';
    }

    function editCommentForm(idRequeriment, idC, isAnswerF, editAnswerF) {
      addComment();
      
      idComment = idC;
      editComment = true;
      isAnswer = isAnswerF;
      editAnswer = editAnswerF;

      if (isAnswerF && !editAnswerF) {
        $('#commentFormTitle').text('New Answer');

        $('input[name=flagRadios][value=green]').prop('checked', true);
        $('#textAreaComment').val('');
        $('#emailNotyfyComment').val('');
      } else {
        let dataToFilter = data.find(d => d.id === idRequeriment.toString());
        let commentToFilter = dataToFilter.comments.find(d => d.id === idComment.toString());
        
        console.log(commentToFilter);

        if (isAnswer) {
          $('#commentFormTitle').text('Edit Answer')

          $('input[name=flagRadios][value='+commentToFilter.flagAnswer+']').prop('checked', true);
          $('#textAreaComment').val(commentToFilter.contentAnswer);
          $('#emailNotyfyComment').val(commentToFilter.emailToNotifyAnswer);
        } else {
          $('#commentFormTitle').text('Edit Comment')

          $('input[name=flagRadios][value='+commentToFilter.flagComment+']').prop('checked', true);
          $('#textAreaComment').val(commentToFilter.contentComment);
          $('#emailNotyfyComment').val(commentToFilter.emailToNotifyComment);
        }
      }
    }

    function printEditionButtonComment(idRequeriment, idComment, isAnswerF, editAnswerF, usernameAnswer) {
      if (!isAnswerF && !editAnswerF && dataUser.role === 'ADMIN') {
        return '<a href="#"><i class="fa fa-edit" onclick="editCommentForm('+idRequeriment+','+idComment+','+isAnswerF+','+editAnswerF+')"></i></a>' +
            '<a href="#"><i class="fa fa-trash" onclick="deleteCommentForm('+idRequeriment+','+idComment+')"></i></a>';
      }  

      if (isAnswerF && !editAnswerF && usernameAnswer === '') {
        return '<a href="#" class="pull-right" style="padding-right: 10%;" onclick="editCommentForm('+idRequeriment+','+idComment+','+isAnswerF+','+editAnswerF+')">Add Answer</a>'
      } 

      if (isAnswerF && editAnswerF && dataUser.role === 'ADMIN') {
        return '<a href="#"><i class="fa fa-edit" onclick="editCommentForm('+idRequeriment+','+idComment+','+isAnswerF+','+editAnswerF+')"></i></a>';
      }

      return ''; 
    }

    function changeRequerimentSelected(id) {
      cancelComment();
        
      $('#commentBody').empty();  

        idRequerimentSelected = id;

        let dataComments = data.find(x => x.id === idRequerimentSelected.toString());
        
        if (dataComments.comments.length > 0) {
            hasComment = true;
          dataComments.comments.forEach(comment => {
            $('#commentBody').append(
            '<div class="direct-chat-msg">'+
            '<div class="direct-chat-info clearfix">'+
              '<span class="direct-chat-name pull-left">'+comment.usernameComment+'</span>'+
              '<span class="direct-chat-timestamp pull-right">'+comment.dateComment+'</span>'+
            '</div>'+
            '<div class="col-xs-11">'+
              '<i class="fa fa-fw fa-flag-o bg-'+comment.flagComment+'" style="    border-radius: 50%; float: left; width: 40px; height: 40px; padding-top: 3%;"></i>'+
              '<div class="direct-chat-text">'+
                ''+comment.contentComment+''+
              '</div>'+
            '</div>'+
            '<div class="col-xs-1" style="padding-top: 2%;">'+
              //'<a href="#"><i class="fa fa-edit"></i></a>'+
              ''+printEditionButtonComment(idRequerimentSelected, comment.id, false, false, comment.usernameAnswer)+''+
            '</div>'+

            //'<a href="#" class="pull-right" style="padding-right: 10%;">Add Answer</a>'+
            ''+printEditionButtonComment(idRequerimentSelected, comment.id, true, false, comment.usernameAnswer)+''+
          '</div>'
          );

          if (comment.usernameAnswer !== '') {
            $('#commentBody').append(
              '<div class="direct-chat-msg right" style="display: block">'+
            '<div class="direct-chat-info clearfix">'+
              '<span class="direct-chat-name pull-right">'+comment.usernameAnswer+'</span>'+
              '<span class="direct-chat-timestamp pull-left">'+comment.dateAnswer+'</span>'+
            '</div>'+
            '<div class="col-xs-1" style="padding-top: 2%;">'+
              //'<a href="#"><i class="fa fa-edit"></i></a>'+
              ''+printEditionButtonComment(idRequerimentSelected, comment.id, true, true, comment.usernameAnswer)+''+
            '</div>'+
            '<div class="col-xs-11">'+
              '<i class="fa fa-fw fa-flag-o bg-'+comment.flagAnswer+' pull-right" style="    border-radius: 50%; float: left; width: 40px; height: 40px; padding-top: 3%;"></i>'+
              '<div class="direct-chat-text">'+
                ''+comment.contentAnswer+''+
              '</div>'+
            '</div>'+
          '</div>'
            );
          }
          });
        } else {
            hasComment = false;
            addComment();
        }
    }

    function addComment() {
        editComment = false;
        isAnswer = false;
        editAnswer = false;

        $('#commentFormTitle').text('New Comment')

        $('#addCommentButton').css('display','none');
        $('#commentBody').css('display','none');
        $('#addCommentForm').css('display','block');
    }

    function cancelComment() {
        editComment = false;
        isAnswer = false;
        editAnswer = false;

        // console.log($('input[name=flagRadios]:checked').val());
        // console.log($('#textAreaComment').val());

        $('input[name=flagRadios][value=green]').prop('checked', true);
        $('#textAreaComment').val('');
        $('#emailNotyfyComment').val('');

        $('#addCommentButton').css('display','block');
        $('#commentBody').css('display','block');
        $('#addCommentForm').css('display','none');

        if (!hasComment){
            hasComment = true;
            $('#modal-comments').modal('toggle');
        }
    }

    function getFormattedDate() {
        const d = new Date().toString();
        return d.substring(8, 10) + ' ' + d.substring(4, 7) + ' ' + d.substring(11, 15) + ', ' + d.substring(16, 21);
    }

    function saveComment() {
        if (editComment) {
            if (isAnswer) {
                //if (editAnswer) {
                  //  console.log('edit answer');
                //} else {
                  //  console.log('new answer');
                //}
                  
                let dataToFilter = data.find(d => d.id === idRequerimentSelected.toString());
                let commentToFilter = dataToFilter.comments.find(d => d.id === idComment.toString());
                // commentToFilter.usernameAnswer = dataUser.username;
                commentToFilter.usernameAnswer = $('#emailNotyfyComment').val();
                commentToFilter.dateAnswer = getFormattedDate();
                commentToFilter.contentAnswer = $('#textAreaComment').val();
                commentToFilter.emailToNotifyAnswer = $('#emailNotyfyComment').val();
                commentToFilter.flagAnswer = $('input[name=flagRadios]:checked').val();
       
                console.log(commentToFilter);
                editCommentAction(commentToFilter);    
            } else {
                console.log('edit comment');

                let dataToFilter = data.find(d => d.id === idRequerimentSelected.toString());
                let commentToFilter = dataToFilter.comments.find(d => d.id === idComment.toString());
                // commentToFilter.usernameComment = dataUser.username;
                commentToFilter.usernameComment = $('#emailNotyfyComment').val();;
                commentToFilter.dateComment = getFormattedDate();
                commentToFilter.contentComment = $('#textAreaComment').val();
                commentToFilter.emailToNotifyComment = $('#emailNotyfyComment').val();
                commentToFilter.flagComment = $('input[name=flagRadios]:checked').val();
       
                console.log(commentToFilter);
                editCommentAction(commentToFilter);
            }
        } else {
            console.log('new comment');
            const comment = {
              // "usernameComment":dataUser.username,
              "usernameComment":$('#emailNotyfyComment').val(),
              "dateComment":getFormattedDate(),
              "contentComment":$('#textAreaComment').val(),
              "emailToNotifyComment":$('#emailNotyfyComment').val(),
              "flagComment":$('input[name=flagRadios]:checked').val(),
              "usernameAnswer":'',
              "dateAnswer":'',
              "contentAnswer":'',
              "emailToNotifyAnswer":'',
              "flagAnswer":'',
              "idRequeriment":idRequerimentSelected
            };

            console.log(comment);
            createComment(comment);
        }
    }

    function createComment(c){
      comment = c;
      $.ajax({
                type: "POST",
                url: "backend/util.php",
                data: {
                    "method" : "createComment",
                    "usernameComment" : comment.usernameComment,
                    "dateComment": comment.dateComment,
                    "contentComment": comment.contentComment,
                    "emailToNotifyComment": comment.emailToNotifyComment,
                    "flagComment": comment.flagComment,
                    "usernameAnswer" : comment.usernameAnswer,
                    "dateAnswer": comment.dateAnswer,
                    "contentAnswer": comment.contentAnswer,
                    "emailToNotifyAnswer": comment.emailToNotifyAnswer,
                    "flagAnswer": comment.flagAnswer,
                    "idRequeriment": comment.idRequeriment
                },
                success: function(response){
                    console.log(response);
                    comment.id = $.parseJSON(response).id;
                    data.find(d => d.id === idRequerimentSelected.toString()).comments.push(comment);
                    hasComment = true;
                    changeRequerimentSelected(idRequerimentSelected);
                }
            });
    }

    function deleteCommentForm(requirementId, commentId){
      $.ajax({
                type: "POST",
                url: "backend/util.php",
                data: {
                    "method" : "deleteComment",
                    "id" : commentId
                },
                success: function(response){
                    console.log(response);
                }
            });

        let dataComments = data.find(x => x.id === requirementId.toString());
        data.find(x => x.id === requirementId.toString()).comments.splice(dataComments.comments.map(x => x.id).indexOf(commentId.toString()), 1);
        changeRequerimentSelected(requirementId);
    }

    function editCommentAction(c){
      comment = c;
      $.ajax({
                type: "POST",
                url: "backend/util.php",
                data: {
                    "method" : "editComment",
                    "id" : comment.id,
                    "usernameComment" : comment.usernameComment,
                    "dateComment": comment.dateComment,
                    "contentComment": comment.contentComment,
                    "emailToNotifyComment": comment.emailToNotifyComment,
                    "flagComment": comment.flagComment,
                    "usernameAnswer" : comment.usernameAnswer,
                    "dateAnswer": comment.dateAnswer,
                    "contentAnswer": comment.contentAnswer,
                    "emailToNotifyAnswer": comment.emailToNotifyAnswer,
                    "flagAnswer": comment.flagAnswer,
                    "idRequeriment": comment.idRequeriment
                },
                success: function(response){
                    console.log(response);
                    let pos = data.find(d => d.id === idRequerimentSelected.toString()).comments.map(x => x.id).indexOf(idComment.toString())
                    data.find(d => d.id === idRequerimentSelected.toString()).comments[pos] = comment;
                    changeRequerimentSelected(idRequerimentSelected);
                }
            });
    }
    //
    // function deleteComment(id) {
    //     $.ajax({
    //         type: "POST",
    //         url: "backend/util.php",
    //         data: {
    //             "method" : "deleteComment",
    //             "id" :id,
    //         },
    //         success: function(response){
    //             console.log(response);
    //         }
    //     });
    // }

    function getComments() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "getComments",
            },
            success: function(response){
//              console.log($.parseJSON(response));

              if ($.parseJSON(response).length > 0){
                data.forEach(d => {
                  d.comments = $.parseJSON(response).filter(c => c.idRequeriment === d.id);
                });
              } else {
                data.forEach(d => {
                  d.comments = [];
                });
              }

              console.log(data);

              fillData(data);

              if (firsTimeFlag) {
                $('#example1').DataTable({
                            'paging'      : false,
                            'lengthChange': false,
                            'searching'   : false,
                            'ordering'    : false,
                            'info'        : false,
                            'autoWidth'   : true
                        });

                $('#example2').DataTable({
                    'paging'      : false,
                    'lengthChange': false,
                    'searching'   : false,
                    'ordering'    : false,
                    'info'        : false,
                    'autoWidth'   : true
                });

                $('#example3').DataTable({
                    'paging'      : false,
                    'lengthChange': false,
                    'searching'   : false,
                    'ordering'    : false,
                    'info'        : false,
                    'autoWidth'   : true
                });
                
                firsTimeFlag = false;
              }
            }
        });
    }

    if (window.sessionStorage.getItem('token') !== null) {
        dataUser = $.parseJSON(window.sessionStorage.getItem('token'))[0];
        $('#username1').text(dataUser.username);
        $('#username2').text(dataUser.username);
        $('#role').text(dataUser.role + ':  ');

        if (dataUser.role !== 'ADMIN') {
            $('#actionRowNotApprovedRequeriments').remove();
        }

        // $('#deadLineInput').datepicker({
        //     autoclose: true
        // });

        getRequeriments();

        $( "#descriptionInput" ).on( "keydown", function(event) {
            if(event.which === 13)
                $( "#descriptionInput" ).val($( "#descriptionInput" ).val() + "<br/>");
        });
        $( "#impactInput" ).on( "keydown", function(event) {
            if(event.which === 13)
                $( "#impactInput" ).val($( "#impactInput" ).val() + "<br/>");
        });
    }else {
        logout();
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Post v2 Roadmap</title>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
  <link rel="stylesheet" href="bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css">
  <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
  <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">

  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<body class="skin-blue sidebar-mini sidebar-collapse" style="height: auto; min-height: 100%;">
<div class="wrapper">
  <header class="main-header">
    <nav class="navbar navbar-static-top" style="margin-left: 0;">
      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          <li class="dropdown user user-menu">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <!--<img src="dist/img/user.png" class="user-image" alt="User Image">-->
              <span class="hidden-xs" id="role"></span>
              <span class="hidden-xs" id="username1"></span>
            </a>
            <ul class="dropdown-menu">
              <li class="user-header">
                <!--<img src="dist/img/user.png" class="img-circle" alt="User Image">-->
                <p id="username2"></p>
              </li>
              <li class="user-footer">
                <div class="pull-right">
                  <a href="#" class="btn btn-default btn-flat" onclick="logout()">Log out</a>
                </div>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <div class="content-wrapper" style="margin-left: 0 !important;">
    <section id="newSection" class="content" style="display: none;">
      <div class="row">
        <div class="col-xs-12">
          <div class="box box-primary">
            <div class="box-header with-border">
              <h3 class="box-title" id="tittleNewEditRequeriment">New Requeriment</h3>
            </div>
            <!-- /.box-header -->
            <!-- form start -->
            <div role="form">
              <div class="box-body">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="priorityInput">Priority</label>
                    <input type="number" class="form-control" id="priorityInput" placeholder="Enter priority">
                  </div>
                  <div class="form-group">
                    <label for="teamInput">Team</label>
                    <input type="text" class="form-control" id="teamInput" placeholder="Enter Team">
                  </div>
                  <div class="form-group">
                    <label>DeadLine</label>

                    <div class="input-group date">
                      <div class="input-group-addon">
                        <i class="fa fa-calendar"></i>
                      </div>
                      <input type="text" class="form-control" id="deadLineInput">
                    </div>
                    <!-- /.input group -->
                  </div>

                  <div class="form-group">
                    <label>Link</label>
                    <div class="input-group">
                      <input id="linkText" type="text" class="form-control" placeholder="Enter a Link" disabled="">
                      <span class="input-group-btn">
                      <button type="button" class="btn btn-info btn-flat" data-toggle="modal" data-target="#modal-default">New</button>
                    </span>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="statusInput">Status</label>
                    <select class="form-control select2 select2-hidden-accessible" style="width: 100%;" tabindex="-1" aria-hidden="true" id="statusInput">
                      <option selected="selected"></option>
                      <option>In queue</option>
                      <option>Processing</option>
                      <option>Completed</option>
                      <option>Blocked</option>
                      <option>Awating</option>
                      <option>Information</option>
                    </select>
                  </div>

                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="idInput">Id</label>
                    <input type="text" class="form-control" id="idInput" placeholder="Enter id">
                  </div>
                  <div class="form-group">
                    <label for="RequerimentInput">Feature / Requeriment</label>
                    <input type="text" class="form-control" id="requerimentInput" placeholder="Enter Feature / Requeriment">
                  </div>
                  <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" rows="5" id="descriptionInput" placeholder="Enter ..."></textarea>
                  </div>
                  <div class="form-group">
                    <label for="teamInput">Notify To Email</label>
                    <input type="email" class="form-control" id="emailToNotify" placeholder="Enter a Email">
                  </div>
                </div>
              </div>

              <div class="box-footer">
                <button class="btn btn-primary" onclick="onSave()">Save</button>
                <button class="btn btn-default" onclick="cancelNewRequeriment()">cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content-header">
      <h1>
        Post v2 Roadmap
        <button id="newSectionButton" type="button" class="btn btn-block btn-primary pull-right" style="width: 10%;" onclick="showNewSection()">New Requeriment</button>
      </h1>
    </section>

    <section class="content">
      <div class="row">
        <div class="col-xs-12">
          <div class="box">
            <div class="box-body">
              <table id="example1" class="table table-bordered table-striped">
                <thead>
                <tr>
                  <th id="actionRowApprovedRequeriments">Actions</th>
                  <th>#</th>
                  <th>Priority</th>
                  <th>Id</th>
                  <th>Team</th>
                  <th>Deadline</th>
                  <th>Feature / Requeriment</th>
                  <th>Description</th>
                  <th>Link</th>
                  <th>Status</th>
                  <th>Observations</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
              </table>
            </div>
            <div class="overlay" style="display: none;">
              <i class="fa fa-refresh fa-spin"></i>
            </div>
          </div>
        </div>
      </div>
    </section>


    <section class="content-header">
      <h1>
        Pending Approval
      </h1>
    </section>

    <section class="content">
      <div class="row">
        <div class="col-xs-12">
          <div class="box">
            <div class="box-body">
              <table id="example2" class="table table-bordered table-striped">
                <thead>
                <tr>
                  <th id="actionRowNotApprovedRequeriments">Actions</th>
                  <th>#</th>
                  <th>Priority</th>
                  <th>Id</th>
                  <th>Team</th>
                  <th>Deadline</th>
                  <th>Feature / Requeriment</th>
                  <th>Description</th>
                  <th>Link</th>
                  <th>Status</th>
                </tr>
                </thead>
                <tbody id="tableBody2">
                </tbody>
              </table>
            </div>
            <div class="overlay" style="display: none;">
              <i class="fa fa-refresh fa-spin"></i>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <div class="control-sidebar-bg"></div>
</div>

<div class="modal fade" id="modal-default">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Link</h4>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Title</label>
          <input id="titleLink" type="text" class="form-control" placeholder="Enter a Title Link">
        </div>
        <div class="form-group">
          <label>Url</label>
          <input id="urlLink" type="text" class="form-control" placeholder="Enter a Url">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveUrl()" data-dismiss="modal">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-delete">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Delete</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure that you want delete this item?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left" onclick="cancelDelete()" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="deleteRequeriment()" data-dismiss="modal">Delete</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-comments">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Comments</h4>
      </div>
      <div class="modal-body">
        <div class="direct-chat-messages" style="display: none;">
          <div class="direct-chat-msg">
            <div class="direct-chat-info clearfix">
              <span class="direct-chat-name pull-left">Alexander Pierce</span>
              <span class="direct-chat-timestamp pull-right">23 Jan 2:00 pm</span>
            </div>
            <div class="col-xs-11">
              <i class="fa fa-fw fa-flag-o bg-green" style="    border-radius: 50%; float: left; width: 40px; height: 40px; padding-top: 2%;"></i>
              <div class="direct-chat-text">
                Is this template really for free? That's unbelievable!
              </div>
            </div>
            <div class="col-xs-1" style="padding-top: 2%;">
              <!--<a href="#"><i class="fa fa-edit"></i></a>-->
            </div>

            <!--<a href="#" class="pull-right" style="padding-right: 10%;">Add Answer</a>-->
          </div>

          <div class="direct-chat-msg right" style="display: block">
            <div class="direct-chat-info clearfix">
              <span class="direct-chat-name pull-right">Sarah Bullock</span>
              <span class="direct-chat-timestamp pull-left">23 Jan 2:05 pm</span>
            </div>
            <div class="col-xs-1" style="padding-top: 2%;">
              <!--<a href="#"><i class="fa fa-edit"></i></a>-->
            </div>
            <div class="col-xs-11">
              <i class="fa fa-fw fa-flag-o bg-yellow pull-right" style="    border-radius: 50%; float: left; width: 40px; height: 40px; padding-top: 2%;"></i>
              <div class="direct-chat-text">
                You better believe it!
              </div>
            </div>
          </div>

          <div class="direct-chat-msg">
            <div class="direct-chat-info clearfix">
              <span class="direct-chat-name pull-left">Alexander Pierce</span>
              <span class="direct-chat-timestamp pull-right">23 Jan 3:00 pm</span>
            </div>
            <div class="col-xs-11">
              <i class="fa fa-fw fa-flag-o bg-red" style="    border-radius: 50%; float: left; width: 40px; height: 40px; padding-top: 2%;"></i>
              <div class="direct-chat-text">
                comment 2
              </div>
            </div>
            <div class="col-xs-1" style="padding-top: 2%;">
              <!--<a href="#"><i class="fa fa-edit"></i></a>-->
            </div>

            <!--<a href="#" class="pull-right" style="padding-right: 10%;">Add Answer</a>-->
          </div>

          <div class="direct-chat-msg">
            <div class="direct-chat-info clearfix">
              <span class="direct-chat-name pull-left">Alexander Pierce</span>
              <span class="direct-chat-timestamp pull-right">23 Jan 3:05 pm</span>
            </div>
            <div class="col-xs-11">
              <i class="fa fa-fw fa-flag-o bg-yellow" style="    border-radius: 50%; float: left; width: 40px; height: 40px; padding-top: 2%;"></i>
              <div class="direct-chat-text">
                comment 3!!
              </div>
            </div>
            <div class="col-xs-1" style="padding-top: 2%;">
              <!--<a href="#"><i class="fa fa-edit"></i></a>-->
            </div>

            <!--<a href="#" class="pull-right" style="padding-right: 10%;">Add Answer</a>-->
          </div>
        </div>

        <div id="addCommentButton" style="display: block;">
          <div class="col-xs-2">
            <button type="button" class="btn btn-block btn-primary" onclick="addComment()"><i class="fa fa-plus"></i></button>
          </div>
          <div class="col-xs-10">
          </div>
        </div>

        <div id="addCommentForm" style="display: none;">
          <div>
            <div class="box-body">
              <h4>New Comment</h4>

              <div class="row">
                <div class="col-xs-1">
                  <div class="radio" style="margin-top: 0;">
                    <label>
                      <input type="radio" name="flagRadios" id="flagRadios1" value="green" checked>
                      <i class="fa fa-fw fa-flag-o bg-green"></i>
                    </label>
                  </div>
                  <div class="radio">
                    <label>
                      <input type="radio" name="flagRadios" id="flagRadios2" value="yellow">
                      <i class="fa fa-fw fa-flag-o bg-yellow"></i>
                    </label>
                  </div>
                  <div class="radio">
                    <label>
                      <input type="radio" name="flagRadios" id="flagRadios3" value="red">
                      <i class="fa fa-fw fa-flag-o bg-red"></i>
                    </label>
                  </div>
                </div>
                <div class="col-xs-11">
                  <textarea class="form-control" rows="3" placeholder="Enter a comment" maxlength="5000" id="textAreaComment"></textarea>
                </div>
              </div>

              <div class="form-group">
                <input type="email" class="form-control" id="emailNotyfyComment" placeholder="Email to Notify">
              </div>
            </div>
            <!-- /.box-body -->
            <div class="box-footer">
              <button id="cancelCommentButton" class="btn btn-default" onclick="cancelComment()">Cancel</button>
              <button class="btn btn-info pull-right" onclick="saveComment()">save</button>
            </div>
            <!-- /.box-footer -->
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <!--<button type="button" class="btn btn-default pull-left" onclick="cancelDelete()" data-dismiss="modal">Cancel</button>-->
        <!--<button type="button" class="btn btn-danger" onclick="deleteRequeriment()" data-dismiss="modal">Delete</button>-->
      </div>
    </div>
  </div>
</div>

<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script src="bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<script src="bower_components/fastclick/lib/fastclick.js"></script>
<script src="bower_components/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
<script src="dist/js/adminlte.min.js"></script>
<script src="dist/js/demo.js"></script>
<script>
    let idToDelete = '';
    let idToEdit = '';
    let data = [];
    let data2 = [];
    let dataToEdit = {};
    let dataUser = {};
    let firsTimeFlag = true;

    let idRequerimentSelected = '';
    let editComment = false;
    let isAnswer = false;
    let editAnswer = false;

    function printBackgroundColor(status) {
        if (status === 'Processing')
          return 'style="background-color: #f39c12;"';

        if (status === 'Blocked')
          return 'style="background-color: #dd4b39;"';

        if (status === 'Completed')
          return 'style="background-color: #63dea6;"';

        return 'style="background-color: #f9f9f9;"';
    }

    function saveUrl() {
        $('#linkText').val($('#titleLink').val());
    }

    function cleanFields() {
        $('#titleLink').val('Confluence Page');
        $('#urlLink').val('');
        $('#linkText').val('');
        $('#priorityInput').val('');
        $('#teamInput').val('');
        $('#idInput').val('');
        $('#deadLineInput').val('');
        $('#requerimentInput').val('');
        $('#statusInput').val('');
        $('#descriptionInput').val('');
    }

    function showNewSection() {
        $('#newSection').css('display','block' );
        $('#newSectionButton').css('display','none' );
        $('#tittleNewEditRequeriment').text('New Requeriment'); 

        cleanFields();
    }

    function cancelNewRequeriment() {
        $('#newSection').css('display','none' );
        $('#newSectionButton').css('display','block' );

        cleanFields();
    }

    function getCustomLink(title, url) {
        return title.length === 0 ? '' : '<a target="_blank" href="'+url+'">'+title+'</a>';
    }

    function onSave() {
        if (idToEdit !== '') {
            editRequeriment();
        }else{
            createRequeriment();
        }
    }

    function createRequeriment() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "createRequeriment",
                "priority": $('#priorityInput').val(),
                "idRow": $('#idInput').val(),
                "team": $('#teamInput').val(),
                "deadLine": $('#deadLineInput').val(),
                "feature": $('#requerimentInput').val(),
                "description": $('#descriptionInput').val(),
                "link": getCustomLink($('#titleLink').val(), $('#urlLink').val()),
                "statusRequeriment": $('#statusInput').val(),
                "approved": 'false',
                "orderRequeriment": '1'
            },
            success: function(response){
                console.log(response);
                cancelNewRequeriment();
                getRequeriments();
            }
        });
    }

    function editRequeriment() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "editRequeriment",
                "id" : idToEdit,
                "priority": $('#priorityInput').val(),
                "idRow": $('#idInput').val(),
                "team": $('#teamInput').val(),
                "deadLine": $('#deadLineInput').val(),
                "feature": $('#requerimentInput').val(),
                "description": $('#descriptionInput').val(),
                "link": getCustomLink($('#titleLink').val(), $('#urlLink').val()),
                "statusRequeriment": $('#statusInput').val(),
                "approved": dataToEdit.approved,
                "orderRequeriment": dataToEdit.orderRequeriment
            },
            success: function(response){
                console.log(response);
                idToEdit = '';
                dataToEdit = {};
                cancelNewRequeriment();
                getRequeriments();
            }
        });
    }

    function editRequerimentCustom() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "editRequeriment",
                "id" : idToEdit,
                "priority": dataToEdit.priority,
                "idRow": dataToEdit.idRow,
                "team": dataToEdit.team,
                "deadLine": dataToEdit.deadLine,
                "feature": dataToEdit.feature,
                "description": dataToEdit.description,
                "link": dataToEdit.link,
                "statusRequeriment": dataToEdit.statusRequeriment,
                "approved": dataToEdit.approved,
                "orderRequeriment": data.filter(d => d.priority === dataToEdit.priority).length + 1
            },
            success: function(response){
                console.log(response);
                idToEdit = '';
                dataToEdit = {};
                cancelNewRequeriment();
                getRequeriments();
            }
        });
    }

    function editRequerimentCustom2() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "editRequeriment",
                "id" : idToEdit,
                "priority": dataToEdit.priority,
                "idRow": dataToEdit.idRow,
                "team": dataToEdit.team,
                "deadLine": dataToEdit.deadLine,
                "feature": dataToEdit.feature,
                "description": dataToEdit.description,
                "link": dataToEdit.link,
                "statusRequeriment": dataToEdit.statusRequeriment,
                "approved": dataToEdit.approved,
                "orderRequeriment": dataToEdit.orderRequeriment
            },
            success: function(response){
                console.log(response);
            },
            async: false
        });
    }

    function orderByPriority(priority){
      let d1 = data.filter(d => d.priority === priority);
      let i = 1;
      d1.forEach(d => {
        d.orderRequeriment = i;
        idToEdit = d.id;
        dataToEdit = d;
        editRequerimentCustom2();
        i++;
      });
    } 

    function orderByPriority2(data, priority){
      let d1 = data.filter(d => d.priority === priority);
      let i = 1;
      d1.forEach(d => {
        d.orderRequeriment = i;
        idToEdit = d.id;
        dataToEdit = d;
        editRequerimentCustom2();
        i++;
      });
    } 

    function getRequerimentsToOrder(priority) {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "getRequeriments",
            },
            success: function(response){
                console.log($.parseJSON(response));
                data = $.parseJSON(response).filter(d => d.approved === 'true');
            orderByPriority2(data, priority);
            },
            async: false
        });
    }

    function approveAll(){
      let d1 = data2;
      let i = 0;
      d1.forEach(d => {
        d.order = i;
        d.approved = 'true';
        idToEdit = d.id;
        dataToEdit = d;
        editRequerimentCustom2();
        i++;
      });
    }

    function editRequerimentCustomWithoutRefreshData(requeriments) {
        requeriments.forEach(d => {
            $.ajax({
                type: "POST",
                url: "backend/util.php",
                data: {
                    "method" : "editRequeriment",
                    "id" : d.id,
                    "priority": d.priority,
                    "idRow": d.idRow,
                    "team": d.team,
                    "deadLine": d.deadLine,
                    "feature": d.feature,
                    "description": d.description,
                    "link": d.link,
                    "statusRequeriment": d.statusRequeriment,
                    "approved": d.approved,
                    "orderRequeriment": d.orderRequeriment
                },
                success: function(response){
                    console.log(response);
                }
            });
        });
    }

    function onEdit(id) {

        idToEdit = id;

        let d1 = data.filter(d => d.id === id.toString())[0];
        console.log(d1);
        showNewSection();
        $('#titleLink').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].text);
        $('#urlLink').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].href);
        $('#linkText').val($(d1.link)[0] === undefined ? '' : $(d1.link)[0].text);
        $('#priorityInput').val(d1.priority);
        $('#teamInput').val(d1.team);
        $('#idInput').val(d1.idRow);
        $('#deadLineInput').val(d1.deadLine);
        $('#requerimentInput').val(d1.feature);
        $('#statusInput').val(d1.statusRequeriment);

        $('#descriptionInput').val(d1.description.replace("<br/>", "<br/>\n"));
        dataToEdit = d1;

        $('#tittleNewEditRequeriment').text('Edit Requeriment');
    }

    function deleteRequeriment() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "deleteRequeriment",
                "id" :idToDelete,
            },
            success: function(response){
                console.log(response);

                let d1 = data.filter(d => d.id === idToDelete.toString());
                let dataToOrder = data.filter(d => (d.priority === d1[0].priority.toString()) && (d.id !== d1[0].id));
                dataToOrder.forEach(dToOrder => {
                    if (dToOrder.orderRequeriment > d1[0].orderRequeriment){
                        dToOrder.orderRequeriment = dToOrder.orderRequeriment - 1;
                    }
                });

                editRequerimentCustomWithoutRefreshData(dataToOrder);

                getRequeriments();
            }
        });
    }

    function setIdToDelete(id) {
        idToDelete = id;
    }

    function cancelDelete() {
        idToDelete = '';
    }

    function upRequeriment(id) {
        let d1 = data.filter(d => d.id === id.toString())[0];
        let d2 = data.filter(d => d.priority === d1.priority);
        if(d2.indexOf(d1)-1 >= 0)  {
            //change order in database
            let d3 = d2[d2.indexOf(d1)-1];
              //params to send
            console.log(d1.id, d3.orderRequeriment);
            console.log(d3.id, d1.orderRequeriment);

            //refresh Data
            let tmp = d1.orderRequeriment;
            data.find(d => d.id === d1.id.toString()).orderRequeriment = d3.orderRequeriment;
            data.find(d => d.id === d3.id.toString()).orderRequeriment = tmp;

            console.log(data);

            fillData(data);

            editRequerimentCustomWithoutRefreshData( [data.find(d => d.id === d1.id.toString()), data.find(d => d.id === d3.id.toString())] )
        }
        console.log(id);
    }

    function downRequeriment(id) {
        let d1 = data.filter(d => d.id === id.toString())[0];
        let d2 = data.filter(d => d.priority === d1.priority);
        if(d2.indexOf(d1)+1 < d2.length)  {
            //change order in database
            let d3 = d2[d2.indexOf(d1)+1];
            //params to send
            console.log(d1.id, d3.orderRequeriment);
            console.log(d3.id, d1.orderRequeriment);

            //refresh Data
            let tmp = d1.orderRequeriment;
            data.find(d => d.id === d1.id.toString()).orderRequeriment = d3.orderRequeriment;
            data.find(d => d.id === d3.id.toString()).orderRequeriment = tmp;

            console.log(data);

            fillData(data);
            editRequerimentCustomWithoutRefreshData( [data.find(d => d.id === d1.id.toString()), data.find(d => d.id === d3.id.toString())] )
        }
        console.log(id);
    }

    function approveRequeriment(id) {
        let d1 = data2.filter(d => d.id === id.toString())[0];
        d1.approved = 'true';
        console.log(d1);
        idToEdit = id;
        dataToEdit = d1;

        editRequerimentCustom();
    }

    function printActions(id) {
        return '' +
            '<a href="#" onclick="upRequeriment('+id+')"><i class="fa fa-arrow-up"></i></span></a> ' +
            '<a href="#" onclick="downRequeriment('+id+')"><i class="fa fa-arrow-down"></i></span></a> ' +
            '<a href="#" onclick="onEdit('+id+')"><i class="fa fa-edit"></i></a> ' +
            '<a href="#" data-toggle="modal" data-target="#modal-delete" onclick="setIdToDelete('+id+')"><i class="fa fa-trash"></i></span></a>' +
            '';
    }

    function printActionEdit(id) {
        return '' +
            '<a href="#" onclick="onEdit('+id+')"><i class="fa fa-edit"></i></a> ' +
            '';
    }

    function printActionApproved(id) {
        return '' +
            '<a href="#" onclick="approveRequeriment('+id+')"><i class="fa fa-check"></i></span></a> ' +
            '';
    }

    function printRandomDisplay() {
        return Math.floor((Math.random() * 2) + 1) === 2 ? "none" : "block";
    }

    function printComments(id) {
        return '' +
            '<a class="btn btn-app btn-app-custom" data-toggle="modal" data-target="#modal-comments" onclick="changeRequerimentSelected('+id+')">\n' +
            '   <span class="badge bg-green" style="display: '+printRandomDisplay()+'">!</span>\n' +
            '   <i class="fa fa-eye"></i>\n' +
            ' </a>' +
            '';
    }

    function fillData(data) {

      let dataTmp = [];

      Array.from(data, x => x.priority).reduce((x, y) => x.includes(y) ? x : [...x, y], []).forEach(pr => {
          let dAux = data.filter(d => d.priority === pr);
          dAux.sort(function(a, b){return a.orderRequeriment-b.orderRequeriment});
          dAux.forEach(a => {
            dataTmp.push(a);
          });
      });

      data = dataTmp;

        $('#tableBody').empty();

        let i = 1;

        if (dataUser.role === 'ADMIN') {
            data.forEach(data => {
                $('#tableBody').append('' +
                    '<tr '+printBackgroundColor(data.statusRequeriment)+'>\n' +
                    '<td style="text-align: center;">'+printActions(data.id)+'</td>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '<td style="text-align: center;">'+printComments(data.id)+'</td>\n' +
                    '</tr>');

                i++;
            });
        } else {
            data.forEach(data => {
                $('#tableBody').append('' +
                    '<tr '+printBackgroundColor(data.statusRequeriment)+'>\n' +
                    '<td style="text-align: center;">'+printActionEdit(data.id)+'</td>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '<td style="text-align: center;">'+printComments(data.id)+'</td>\n' +
                    '</tr>');

                i++;
            });
        }

         dataTmp = [];

      Array.from(data2, x => x.priority).reduce((x, y) => x.includes(y) ? x : [...x, y], []).forEach(priority => {
          dAux = data2.filter(d => d.priority === priority);
          dAux.sort(function(a, b){return a.orderRequeriment-b.orderRequeriment});
          dAux.forEach(a => {
            dataTmp.push(a);
          });
      });

      data2 = dataTmp;

        $('#tableBody2').empty();
        i = 1;

        if (dataUser.role === 'ADMIN') {
            data2.forEach(data => {
                $('#tableBody2').append('' +
                    '<tr '+printBackgroundColor(data.statusRequeriment)+'>\n' +
                    '<td style="text-align: center;">'+printActionApproved(data.id)+'</td>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '</tr>');

                i++;
            });
        } else {
            data2.forEach(data => {
                $('#tableBody2').append('' +
                    '<tr '+printBackgroundColor(data.statusRequeriment)+'>\n' +
                    '<td style="text-align: center;">'+i+'</td>\n' +
                    '<td style="text-align: center;">'+data.priority+'</td>\n' +
                    '<td>'+data.idRow+'</td>\n' +
                    '<td>'+data.team+'</td>\n' +
                    '<td>'+data.deadLine+'</td>\n' +
                    '<td>'+data.feature+'</td>\n' +
                    '<td>'+data.description+'</td>\n' +
                    '<td>'+data.link+'</td>\n' +
                    '<td>'+data.statusRequeriment+'</td>\n' +
                    '</tr>');

                i++;
            });
        }
    }

    function getRequeriments() {
        $.ajax({
            type: "POST",
            url: "backend/util.php",
            data: {
                "method" : "getRequeriments",
            },
            success: function(response){
              if ($.parseJSON(response).length > 0){
                console.log($.parseJSON(response));
                data = $.parseJSON(response).filter(d => d.approved === 'true');
                data2 = $.parseJSON(response).filter(d => d.approved !== 'true');
                fillData(data);

                if (firsTimeFlag) {
                  $('#example1').DataTable({
                              'paging'      : false,
                              'lengthChange': false,
                              'searching'   : false,
                              'ordering'    : false,
                              'info'        : false,
                              'autoWidth'   : true
                          });

                  $('#example2').DataTable({
                      'paging'      : false,
                      'lengthChange': false,
                      'searching'   : false,
                      'ordering'    : false,
                      'info'        : false,
                      'autoWidth'   : true
                  });
                  
                  firsTimeFlag = false;
                }
                
              } else {
                $('#tableBody').empty();
              }
            }
        });
    }

    function logout() {
        window.sessionStorage.setItem('token', null);
        window.location = 'login.html';
    }

    function changeRequerimentSelected(id) {
        idRequerimentSelected = id;
    }

    function addComment() {
        let editComment = false;
        let isAnswer = false;
        let editAnswer = false;

        $('#addCommentButton').css('display','none');
        $('#addCommentForm').css('display','block');
    }

    function cancelComment() {
        let editComment = false;
        let isAnswer = false;
        let editAnswer = false;

        // console.log($('input[name=flagRadios]:checked').val());
        // console.log($('#textAreaComment').val());

        $('input[name=flagRadios][value=green]').prop('checked', true);
        $('#textAreaComment').val('');
        $('#emailNotyfyComment').val('');

        $('#addCommentButton').css('display','block');
        $('#addCommentForm').css('display','none');
    }

    function getFormattedDate() {
        const d = new Date().toString();
        return d.substring(8, 10) + ' ' + d.substring(4, 7) + ' ' + d.substring(11, 15) + ', ' + d.substring(16, 21);
    }

    function saveComment() {
        if (editComment) {
            if (isAnswer) {
                if (editAnswer) {
                    console.log('edit comment');
                } else {
                    console.log('new answer');
                }
            } else {
                console.log('edit comment');
            }
        } else {
            console.log('new comment');
        }

        console.log(idRequerimentSelected);
        console.log($('input[name=flagRadios]:checked').val());
        console.log($('#textAreaComment').val());
        console.log($('#emailNotyfyComment').val());
        console.log(dataUser.username);
        console.log(getFormattedDate());
        console.log('COMMENT');
    }

    if (window.sessionStorage.getItem('token') !== null) {
        dataUser = $.parseJSON(window.sessionStorage.getItem('token'))[0];
        $('#username1').text(dataUser.username);
        $('#username2').text(dataUser.username);
        $('#role').text(dataUser.role + ':  ');

        if (dataUser.role !== 'ADMIN') {
            $('#actionRowNotApprovedRequeriments').css('display', 'none');
        }

        $('#deadLineInput').datepicker({
            autoclose: true
        });

        getRequeriments();

        $( "#descriptionInput" ).on( "keydown", function(event) {
            if(event.which === 13)
                $( "#descriptionInput" ).val($( "#descriptionInput" ).val() + "<br/>");
        });
    }else {
        logout();
    }
</script>
</body>
</html>
